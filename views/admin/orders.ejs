<div class="row g-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Order Management</h5>
                <div>
                    <input type="text" class="form-control d-inline-block" style="width: 200px;" placeholder="Search orders..." id="searchInput">
                    <select class="form-select d-inline-block ms-2" style="width: 150px;" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="shipped">Shipped</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
            </div>
            <div id="statusMessage" class="alert alert-success alert-dismissible fade show d-none" role="alert">
                <span id="statusMessageText"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" onclick="onMessageClose()"></button>
            </div>
            <div class="card-body">
                <form action="/admin/orders/bulk-action" method="POST" id="bulkActionForm">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <button type="submit" name="action" value="deliver" class="btn btn-success btn-sm" disabled id="bulkDeliverBtn">
                                <i class="fas fa-check me-1"></i>Mark as Delivered
                            </button>
                            <button type="submit" name="action" value="cancel" class="btn btn-danger btn-sm ms-2" disabled id="bulkCancelBtn">
                                <i class="fas fa-times me-1"></i>Cancel Orders
                            </button>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAll">
                            <label class="form-check-label" for="selectAll">
                                Select All
                            </label>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAll" class="form-check-input">
                                    </th>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Products</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% orders.forEach(order => { %>
                                    <tr>
                                        <td>
                                            <% if (order.status !== 'delivered' && order.status !== 'cancelled') { %>
                                                <input type="checkbox" name="order_ids" value="<%= order.order_id %>" class="form-check-input order-checkbox">
                                            <% } %>
                                        </td>
                                        <td>
                                            <strong>#<%%= order.order_id %></strong>
                                            <% if (order.tracking_number) { %>
                                                <br><small class="text-muted">Track: <%= order.tracking_number %></small>
                                            <% } %>
                                        </td>
                            <td>
                                    <%= order.customer_name || 'Guest' %>
                                    <% if (order.guest_email) { %>
                                        <br><small class="text-muted">Email: <%= order.guest_email %></small>
                                    <% } %>
                                    <% if (order.billing_address && order.billing_address.telegram_id) { %>
                                        <br><small class="text-muted">Telegram: @<%= order.billing_address.telegram_id %></small>
                                    <% } %>
                                    <% if (order.customer_email && order.customer_email !== order.guest_email) { %>
                                        <br><small class="text-muted">Alt Email: <%= order.customer_email %></small>
                                    <% } %>
                                </td>
                                        <td>
                                            <% if (order.items && order.items.length > 0) { %>
                                                <%= order.items.length %> item(s)
                                                <% order.items.slice(0, 2).forEach(item => { %>
                                                    <br><small class="text-muted"><%= item.product_name || 'Product' %> (Qty: <%= item.quantity %>)</small>
                                                <% }) %>
                                                <% if (order.items.length > 2) { %>
                                                    <br><small class="text-muted">+<%= order.items.length - 2 %> more...</small>
                                                <% } %>
                                            <% } else { %>
                                                <small class="text-muted">No items</small>
                                            <% } %>
                                        </td>
                                        <td><strong>$<%= order.total_amount %></strong></td>
                                        <td>
                                            <span class="badge bg-<% if (order.status === 'delivered') { %>success<% } else if (order.status === 'shipped') { %>info<% } else if (order.status === 'pending') { %>warning<% } else { %>danger<% } %>">
                                                <%= order.status %>
                                            </span>
                                        </td>
                                        <td>
                                            <%= new Date(order.created_at).toLocaleDateString() %>
                                            <br><small class="text-muted"><%= new Date(order.created_at).toLocaleTimeString() %></small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="#orderModal" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-order-id="<%= order.order_id %>">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <% if (order.status === 'pending') { %>
                                                    <form action="/admin/orders/<%= order.order_id %>/status" method="POST" class="d-inline">
                                                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                                        <input type="hidden" name="status" value="delivered">
                                                        <button type="submit" class="btn btn-success btn-sm" title="Mark as Delivered">
                                                            <i class="fas fa-check-circle"></i>
                                                        </button>
                                                    </form>
                                                <% } %>
                                                <% if (order.status === 'shipped') { %>
                                                    <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#verifyModal"
                                                            data-order-id="<%= order.order_id %>" data-customer="<%= order.customer_name || 'Guest' %>"
                                                            title="Mark as Delivered">
                                                        <i class="fas fa-check-double"></i>
                                                    </button>
                                                <% } %>
                                                <% if (order.status !== 'delivered' && order.status !== 'cancelled') { %>
                                                    <form action="/admin/orders/<%= order.order_id %>/status" method="POST" class="d-inline">
                                                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                                        <input type="hidden" name="status" value="cancelled">
                                                        <button type="submit" class="btn btn-danger btn-sm" title="Cancel Order" onclick="return confirm('Are you sure you want to cancel this order?')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </form>
                                                <% } %>
                                            </div>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>

                    <% if (!orders || orders.length === 0) { %>
                        <div class="text-center py-5">
                            <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No orders found</h5>
                            <p class="text-muted">Orders will appear here when customers make purchases.</p>
                        </div>
                    <% } %>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderModalBody">
                <!-- Order details will be loaded here -->
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Order Verification Modal -->
<div class="modal fade" id="verifyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Verify and Deliver Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="" method="POST" id="verifyForm">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <div class="modal-body">
                    <p>Confirm delivery for <strong id="verifyCustomer"></strong>?</p>
                    <div class="mb-3">
                        <label for="verification_notes" class="form-label">Delivery Notes (Optional)</label>
                        <textarea class="form-control" id="verification_notes" name="verification_notes"
                                  rows="3" placeholder="Optional delivery notes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Confirm Delivery</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');

    function filterOrders() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusTerm = statusFilter.value.toLowerCase();

        const rows = document.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const matchesSearch = !searchTerm || text.includes(searchTerm);
            const matchesStatus = !statusTerm || row.querySelector('.badge').textContent.toLowerCase().includes(statusTerm);

            row.style.display = matchesSearch && matchesStatus ? '' : 'none';
        });
    }

    searchInput.addEventListener('input', filterOrders);
    statusFilter.addEventListener('change', filterOrders);

    // Bulk selection
    const selectAllCheckbox = document.getElementById('selectAll');
    const orderCheckboxes = document.querySelectorAll('.order-checkbox');

    selectAllCheckbox.addEventListener('change', function() {
        orderCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateBulkButtons();
    });

    orderCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const allChecked = Array.from(orderCheckboxes).every(cb => cb.checked);
            const noneChecked = Array.from(orderCheckboxes).every(cb => !cb.checked);

            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = !allChecked && !noneChecked;
            updateBulkButtons();
        });
    });

    function updateBulkButtons() {
        const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
        const bulkDeliverBtn = document.getElementById('bulkDeliverBtn');
        const bulkCancelBtn = document.getElementById('bulkCancelBtn');

        const hasChecked = checkedBoxes.length > 0;
        bulkDeliverBtn.disabled = !hasChecked;
        bulkCancelBtn.disabled = !hasChecked;
    }

    // Order verification modal
    const verifyModal = document.getElementById('verifyModal');
    verifyModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const orderId = button.getAttribute('data-order-id');
        const customer = button.getAttribute('data-customer');

        document.getElementById('verifyCustomer').textContent = customer;
        document.getElementById('verifyForm').action = `/admin/orders/${orderId}/verify`;
    });

    // Status message handling
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('action')) {
        const action = urlParams.get('action');
        const orderId = urlParams.get('orderId');
        if (action === 'delivered') {
            showStatusMessage('We process orders within 30 minutes to 6 hours.', 'processing');
            setTimeout(() => {
                showStatusMessage(`Order #${orderId} is delivered. Customer will be notified to check their email and telegram.`, 'delivered');
            }, 30000);
        }
    }

    function showStatusMessage(message, type) {
        const statusDiv = document.getElementById('statusMessage');
        const textSpan = document.getElementById('statusMessageText');
        textSpan.textContent = message;
        statusDiv.className = type === 'delivered' ? 'alert alert-success alert-dismissible fade show' : 'alert alert-warning alert-dismissible fade show';
        statusDiv.classList.remove('d-none');
    }

    function onMessageClose() {
        location.reload();
    }
});
</script>
