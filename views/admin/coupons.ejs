<div class="row g-4">
    <!-- Add Coupon -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Add New Coupon</h5>
            </div>
            <div class="card-body">
                <form action="/admin/coupons" method="POST" id="addCouponForm">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="code" class="form-label">Coupon Code</label>
                            <input type="text" class="form-control" id="code" name="code" placeholder="SUMMER20" required>
                        </div>
                        <div class="col-md-2">
                            <label for="discount_type" class="form-label">Discount Type</label>
                            <select class="form-select" id="discount_type" name="discount_type" required>
                                <option value="percentage">Percentage</option>
                                <option value="fixed">Fixed Amount</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="discount_value" class="form-label">Value</label>
                            <input type="number" class="form-control" id="discount_value" name="discount_value"
                                   min="0" step="0.01" placeholder="20" required>
                        </div>
                        <div class="col-md-2">
                            <label for="min_order_amount" class="form-label">Min Order</label>
                            <input type="number" class="form-control" id="min_order_amount" name="min_order_amount"
                                   min="0" step="0.01" placeholder="0">
                        </div>
                        <div class="col-md-2">
                            <label for="usage_limit" class="form-label">Usage Limit</label>
                            <input type="number" class="form-control" id="usage_limit" name="usage_limit"
                                   min="1" placeholder="100">
                        </div>
                        <div class="col-md-1">
                            <label for="expires_at" class="form-label">Expires</label>
                            <input type="date" class="form-control" id="expires_at" name="expires_at">
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="is_active" name="is_active" checked>
                            <label class="form-check-label" for="is_active">
                                Active
                            </label>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-plus me-2"></i>Add Coupon
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Coupons List -->
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-ticket-alt me-2"></i>Coupon Management</h5>
                <div>
                    <input type="text" class="form-control d-inline-block" style="width: 200px;" placeholder="Search coupons..." id="searchInput">
                    <select class="form-select d-inline-block ms-2" style="width: 150px;" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="expired">Expired</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Discount</th>
                                <th>Usage</th>
                                <th>Min Order</th>
                                <th>Expires</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% coupons.forEach(coupon => { %>
                                <tr>
                                    <td>
                                        <strong class="text-uppercase"><%= coupon.code %></strong>
                                    </td>
                                    <td>
                                        <% if (coupon.discount_type === 'percentage') { %>
                                            <%= coupon.discount_value %>% off
                                        <% } else { %>
                                            $<%= coupon.discount_value %>
                                        <% } %>
                                    </td>
                                    <td>
                                        <%= coupon.usage_count || 0 %>
                                        <% if (coupon.usage_limit) { %>
                                            / <%= coupon.usage_limit %>
                                        <% } %>
                                    </td>
                                    <td>
                                        <% if (coupon.min_order_amount) { %>
                                            $<%= coupon.min_order_amount %>
                                        <% } else { %>
                                            <small class="text-muted">None</small>
                                        <% } %>
                                    </td>
                                    <td>
                                        <% if (coupon.expires_at) { %>
                                            <%= new Date(coupon.expires_at).toLocaleDateString() %>
                                            <% const daysLeft = Math.ceil((new Date(coupon.expires_at) - new Date()) / (1000 * 60 * 60 * 24)) %>
                                            <% if (daysLeft < 0) { %>
                                                <br><small class="text-danger">Expired</small>
                                            <% } else if (daysLeft <= 7) { %>
                                                <br><small class="text-warning"><%= daysLeft %> days left</small>
                                            <% } %>
                                        <% } else { %>
                                            <small class="text-muted">Never</small>
                                        <% } %>
                                    </td>
                                    <td>
                                        <%
                                            const isExpired = coupon.expires_at && new Date(coupon.expires_at) < new Date();
                                            const isLimitReached = coupon.usage_limit && coupon.usage_count >= coupon.usage_limit;
                                            const status = isExpired ? 'expired' : (!coupon.is_active || isLimitReached ? 'inactive' : 'active');
                                        %>
                                        <span class="badge bg-<%= status === 'active' ? 'success' : status === 'expired' ? 'warning' : 'secondary' %>">
                                            <%= status.charAt(0).toUpperCase() + status.slice(1) %>
                                        </span>
                                        <% if (isLimitReached) { %>
                                            <br><small class="text-muted">Limit reached</small>
                                        <% } %>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <% if (coupon.is_active && !isExpired && !isLimitReached) { %>
                                                <button class="btn btn-outline-success btn-sm" data-bs-toggle="modal" data-bs-target="#copyModal"
                                                        data-code="<%= coupon.code %>" title="Copy Code">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            <% } %>
                                            <button class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editCouponModal"
                                                    data-coupon-id="<%= coupon.coupon_id %>" data-code="<%= coupon.code %>"
                                                    data-discount-type="<%= coupon.discount_type %>" data-discount-value="<%= coupon.discount_value %>"
                                                    data-min-order="<%= coupon.min_order_amount || '' %>" data-usage-limit="<%= coupon.usage_limit || '' %>"
                                                    data-expires-at="<%= coupon.expires_at ? new Date(coupon.expires_at).toISOString().split('T')[0] : '' %>"
                                                    data-is-active="<%= coupon.is_active %>" title="Edit Coupon">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#confirmModal"
                                                    data-action="delete" data-coupon-id="<%= coupon.coupon_id %>" data-coupon-code="<%= coupon.code %>"
                                                    title="Delete Coupon">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>

                <% if (!coupons || coupons.length === 0) { %>
                    <div class="text-center py-5">
                        <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No coupons found</h5>
                        <p class="text-muted">Create your first coupon using the form above.</p>
                    </div>
                <% } %>

                <!-- Copy Code Modal -->
                <div class="modal fade" id="copyModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Coupon Code</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>Use this coupon code at checkout:</p>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="couponCodeDisplay" readonly>
                                    <button class="btn btn-outline-secondary" type="button" id="copyCodeBtn">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Done</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Edit Coupon Modal -->
                <div class="modal fade" id="editCouponModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Edit Coupon</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <form action="/admin/coupons/update" method="POST" id="editCouponForm">
                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                <input type="hidden" name="coupon_id" id="editCouponId">
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="editCode" class="form-label">Coupon Code</label>
                                        <input type="text" class="form-control" id="editCode" name="code" required>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="editDiscountType" class="form-label">Discount Type</label>
                                            <select class="form-select" id="editDiscountType" name="discount_type" required>
                                                <option value="percentage">Percentage</option>
                                                <option value="fixed">Fixed Amount</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="editDiscountValue" class="form-label">Value</label>
                                            <input type="number" class="form-control" id="editDiscountValue" name="discount_value"
                                                   min="0" step="0.01" required>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label for="editMinOrder" class="form-label">Min Order Amount</label>
                                            <input type="number" class="form-control" id="editMinOrder" name="min_order_amount"
                                                   min="0" step="0.01">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="editUsageLimit" class="form-label">Usage Limit</label>
                                            <input type="number" class="form-control" id="editUsageLimit" name="usage_limit"
                                                   min="1">
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label for="editExpiresAt" class="form-label">Expiration Date</label>
                                        <input type="date" class="form-control" id="editExpiresAt" name="expires_at">
                                    </div>
                                    <div class="mt-3 form-check">
                                        <input type="checkbox" class="form-check-input" id="editIsActive" name="is_active">
                                        <label class="form-check-label" for="editIsActive">
                                            Active
                                        </label>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Confirmation Modal -->
                <div class="modal fade" id="confirmModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Confirm Deletion</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>Are you sure you want to delete the coupon "<strong id="confirmCouponCode"></strong>"?</p>
                                <small class="text-muted">This action cannot be undone.</small>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" id="confirmBtn">Delete Coupon</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');

    function filterCoupons() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusTerm = statusFilter.value.toLowerCase();

        const rows = document.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const statusBadge = row.querySelector('.badge').textContent.toLowerCase();

            const matchesSearch = !searchTerm || text.includes(searchTerm);
            const matchesStatus = !statusTerm || statusBadge.includes(statusTerm);

            row.style.display = matchesSearch && matchesStatus ? '' : 'none';
        });
    }

    searchInput.addEventListener('input', filterCoupons);
    statusFilter.addEventListener('change', filterCoupons);

    // Copy code modal
    const copyModal = document.getElementById('copyModal');
    copyModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const code = button.getAttribute('data-code');

        document.getElementById('couponCodeDisplay').value = code;
    });

    // Copy to clipboard
    document.getElementById('copyCodeBtn').addEventListener('click', function() {
        const codeInput = document.getElementById('couponCodeDisplay');
        codeInput.select();
        document.execCommand('copy');

        this.innerHTML = '<i class="fas fa-check"></i> Copied!';
        setTimeout(() => {
            this.innerHTML = '<i class="fas fa-copy"></i> Copy';
        }, 2000);
    });

    // Edit coupon modal
    const editCouponModal = document.getElementById('editCouponModal');
    editCouponModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;

        document.getElementById('editCouponId').value = button.getAttribute('data-coupon-id');
        document.getElementById('editCode').value = button.getAttribute('data-code');
        document.getElementById('editDiscountType').value = button.getAttribute('data-discount-type');
        document.getElementById('editDiscountValue').value = button.getAttribute('data-discount-value');
        document.getElementById('editMinOrder').value = button.getAttribute('data-min-order');
        document.getElementById('editUsageLimit').value = button.getAttribute('data-usage-limit');
        document.getElementById('editExpiresAt').value = button.getAttribute('data-expires-at');
        document.getElementById('editIsActive').checked = button.getAttribute('data-is-active') === 'true';
    });

    // Confirmation modal
    const confirmModal = document.getElementById('confirmModal');
    const confirmBtn = document.getElementById('confirmBtn');
    const confirmCouponCode = document.getElementById('confirmCouponCode');

    confirmModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const couponId = button.getAttribute('data-coupon-id');
        const couponCode = button.getAttribute('data-coupon-code');

        confirmCouponCode.textContent = couponCode;
        confirmBtn.setAttribute('data-coupon-id', couponId);
    });

    confirmBtn.addEventListener('click', function() {
        const couponId = this.getAttribute('data-coupon-id');
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/coupons/${couponId}/delete`;

        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = '_csrf';
        csrfInput.value = '<%= csrfToken %>';
        form.appendChild(csrfInput);

        document.body.appendChild(form);
        form.submit();
    });

    // Show success message for form submissions
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success')) {
        showNotification('Coupon updated successfully!', 'success');
    }
});
</script>
